<!DOCTYPE html>
<html>
<head>
<body>
<canvas id="canvas" width=200 height=200></canvas>
<input type="range" id="threshold" min="-256" max="255">
<output for="threshold"> </output>
<h1 id="FPS">number of frames</h1>
<script>
var getUserMedia = navigator.getUserMedia || navigator.webkitGetUserMedia ||
                   navigator.mozGetUserMedia || navigator.msGetUserMedia;
var URL = window.URL || window.webkitURL || window.mozURL || window.msURL;

var cameraEl = document.getElementById('camera');
var canvasEl = document.getElementById('canvas');

var thresholder = document.getElementById('threshold');
var thresholderOutput = document.querySelector('[for="threshold"]');
var threshold = thresholder.value;
thresholder.addEventListener("change", function(){
	threshold = thresholder.value;
	thresholderOutput.value = threshold;
});

function FPSTracker(){
	this.renderTimes = [];
}
FPSTracker.prototype.trackRender = function(){
	this.renderTimes.push(+new Date);
	if (this.renderTimes.length > 20) {
		this.renderTimes.shift();
	}
};
FPSTracker.prototype.getFPS = function(){
	return this.renderTimes.length / (+new Date() - this.renderTimes[0]) * 1000;
}

getUserMedia.call(navigator, 'video', function(stream){
	var videoEl = document.createElement('video');
	//document.body.appendChild(videoEl);
	videoEl.src = URL.createObjectURL(stream);
	videoEl.play();
	//cameraEl.play();
	var canvas = document.getElementById('canvas'),
	    inputCanvas = document.createElement('canvas'),
	    ctx = canvas.getContext('2d'),
		inputCtx = inputCanvas.getContext('2d');

	document.body.insertBefore(inputCanvas, canvas);

	inputCanvas.width = inputCanvas.height = 200;
	

	videoEl.addEventListener('play', function(){
		// canvas.width = videoEl.videoWidth;
		// canvas.height = videoEl.videoHeight;
	});

	var FPSdisplay = document.getElementById('FPS').firstChild;
	var FPS = new FPSTracker;

	setInterval(function(){
		var r, g, b, a, inputImage, finalImage;
		inputCtx.drawImage(videoEl, 0, 0, 200, 200);
		inputImage = inputCtx.getImageData(0, 0, 200, 200);
		finalImage = ctx.createImageData(200, 200);
		for (var i = 0, l = inputImage.data.length; i < l; i++) {
			//finalImage.data[i] = inputImage.data[i%4 === 0 ? i + 1 : i%4 === 1 ? i - 1 : i];
			r = inputImage.data[i];
			g = inputImage.data[++i];
			b = inputImage.data[++i];
			a = inputImage.data[++i];
			
			if (r - b - g > threshold){
				newR = g;
				g = r;
				r = newR
			}
			finalImage.data[i-3] = r;
			finalImage.data[i-2] = g;
			finalImage.data[i-1] = b;
			finalImage.data[i] = a;
		}
		ctx.putImageData(finalImage, 0, 0);
		FPS.trackRender();
		FPSdisplay.nodeValue = Math.floor(FPS.getFPS() * 10 + 0.5) / 10;

	}, 20);
});
</script>
