<!DOCTYPE html>
<html>
<head>
<style>
	#controls>tbody>tr>th{
		text-align: right;
		padding-right: 0.5em;
	}
</style>
<body>
<canvas id="canvas" width=200 height=200></canvas>
<span style="font-size: 1.5em" id="FPS">number of frames</span>
<table id="controls">
	<tr>
		<th>Hue</th>
		<td>
			<input data-control type="range" id="hueLevel" min="0" max="360" value="0">
			<output for="hueLevel"></output>
		</td>
	</tr>
	<tr>
		<th>Hue leniency</th>
		<td>
			<input data-control type="range" id="hueWindow" min="0" max="360" value="0">
			<output for="hueWindow"></output>
		</td>
	</tr>
	<tr>
		<th>Saturation</th>
		<td>
			<input data-control type="range" id="saturationLevel" min="0" max="1" step="0.01" value="0.8">
			<output for="saturationLevel"></output>
		</td>
	</tr>
	<tr>
		<th>Saturation leniency</th>
		<td>
			<input data-control type="range" id="saturationWindow" min="0" max="1" step="0.01" value="0.5">
			<output for="saturationWindow"></output>
		</td>
	</tr>
	<tr>
		<th>Color shift</th>
		<td>
			<input data-control type="range" id="hueShift" min="0" max="360" value="120" step="1">
			<output for="hueShift"></output>
		</td>
	</tr>
	<tr>
		<th>Saturation shift</th>
		<td>
			<input data-control type="range" id="saturationShift" min="-1" max="1" value="0" step=".01">
			<output for="saturationShift"></output>
		</td>
	</tr>
	<tr>
		<th>Test Pattern</th>
		<td><input type="checkbox" id="testPattern"></td>
	</tr>
	<tr>
		<th>Mystery Feature</th>
        <td><input type="checkbox" id="animate"></td>
	</tr>
</table>
<script>
var getUserMedia = navigator.getUserMedia || navigator.webkitGetUserMedia ||
                   navigator.mozGetUserMedia || navigator.msGetUserMedia;

var URL = window.URL || window.webkitURL || window.mozURL || window.msURL;

var videoEl = document.createElement('video');
var cameraEl = document.getElementById('camera');
var canvasEl = document.getElementById('canvas');

function Control(element){
	this.element = element;
    this.output = document.querySelector('[for="' + element.id + '"]');
	this.output.value = this.value = +element.value;
	element.addEventListener("change", function(){
		this.output.value = this.value = (Math.floor(+element.value*100) / 100);
	}.bind(this));
}
var controls = {};
Array.prototype.forEach.call(document.querySelectorAll("[data-control]"), function(element){
	controls[element.id] = new Control(element);
});

function FPSTracker(){
	this.renderTimes = [];
}
FPSTracker.prototype.trackRender = function(){
	this.renderTimes.push(+new Date);
	if (this.renderTimes.length > 20) {
		this.renderTimes.shift();
	}
};
FPSTracker.prototype.getFPS = function(){
	return this.renderTimes.length / (+new Date() - this.renderTimes[0]) * 1000;
};

function start(){
	var canvas = document.getElementById('canvas'),
	    inputCanvas = document.createElement('canvas'),
	    ctx = canvas.getContext('2d'),
		inputCtx = inputCanvas.getContext('2d');

	document.body.insertBefore(inputCanvas, canvas);

	inputCanvas.width = inputCanvas.height = 200;
	

	videoEl.addEventListener('play', function(){
		// canvas.width = videoEl.videoWidth;
		// canvas.height = videoEl.videoHeight;
	});

	var FPSdisplay = document.getElementById('FPS').firstChild;
	var FPS = new FPSTracker;

	setInterval(function(){
		var r, g, b, a, hsv, newH, newS, hueDistance, inputImage, finalImage, rgb, x, y;
            inputCtx.drawImage(videoEl, 0, 0, 200, 200);
            inputImage = inputCtx.getImageData(0, 0, 200, 200);
            finalImage = ctx.createImageData(200, 200);
        var hueDifference = controls.hueWindow.value / 2;
        var saturationDifference = controls.saturationWindow.value / 2;
		for (var i = 0, l = inputImage.data.length; i < l; i++) {
            r = inputImage.data[i];
            g = inputImage.data[++i];
            b = inputImage.data[++i];
            a = inputImage.data[++i];
            hsv = rgb2hsv(r, g, b);
            if (useTestPattern){
                x = ((i+1) / 4) % 200;
                y = Math.floor(((i+1) / 4) / 200);
                hsv = {
                    h: Math.floor(x * 360 / 200),
                    s: 1 - (y / 200),
                    v: .9
                }
                rgb = hsv2rgb(hsv.h, hsv.s, hsv.v);
                r = rgb.r;
                g = rgb.g;
                b = rgb.b;
            }
			
            if ((180 - Math.abs(Math.abs(hsv.h - controls.hueLevel.value) - 180) < hueDifference)
                && (hsv.s > controls.saturationLevel.value - saturationDifference && hsv.s < controls.saturationLevel.value + saturationDifference)
            ){
                newH = hsv.h + controls.hueShift.value;
                newS = Math.min(Math.max(hsv.s + controls.saturationShift.value, 0), 1);
				newV = hsv.v;
                rgb = hsv2rgb(newH, newS, newV);
                r = rgb.r;
                g = rgb.g;
                b = rgb.b;
            }
			finalImage.data[i-3] = r;
			finalImage.data[i-2] = g;
			finalImage.data[i-1] = b;
			finalImage.data[i] = a;
		}
		ctx.putImageData(finalImage, 0, 0);
		FPS.trackRender();
		FPSdisplay.nodeValue = Math.floor(FPS.getFPS() * 10 + 0.5) / 10;

	}, 20);
};

function fallback(){
	//videoEl.src = 'fallback.webm';
	videoEl.src = 'test.webm';
	videoEl.loop = true;
	videoEl.play();
	start();
}
if(getUserMedia){
	getUserMedia.call(navigator, 'video', function(stream){
		videoEl.src = URL.createObjectURL(stream);
		videoEl.play();
		start();
	}, function(){
		fallback();
	});
} else {
	fallback();
}

// code translated from http://code.activestate.com/recipes/576919-python-rgb-and-hsv-conversion/
// in turn from wikipedia: http://en.wikipedia.org/wiki/HSL_and_HSV#Converting_to_RGB
function rgb2hsv(r, g, b){
	r = r/255;
	g = g/255;
	b = b/255;
    var mx = Math.max(r, g, b),
        mn = Math.min(r, g, b),
        df = mx - mn,
		h, s, v;
	if (mx === mn) {
		h = 0;
	} else if (mx === r) {
        h = (60 * ((g-b)/df) + 360) % 360;
	} else if (mx === g) {
        h = (60 * ((b-r)/df) + 120) % 360;
	} else if (mx === b) {
        h = (60 * ((r-g)/df) + 240) % 360;
	}
	if (mx == 0){
        s = 0;
	} else {
        s = df/mx;
	}
    v = mx;
	return { h: h, s: s, v: v };
}

var hsv2rgb = function(h, s, v){
    var h60, hi, f, p, q, t, r = 0, g = 0, b = 0;
    h60 = h / 60;
    h60f = Math.floor(h60);
    hi = Math.floor(h60f) % 6;
    f = h60 - h60f;
    p = v * (1 - s);
    q = v * (1 - f * s);
    t = v * (1 - (1 - f) * s);
    if      (hi == 0) {r = v; g = t; b = p;}
    else if (hi == 1) {r = q; g = v; b = p;}
    else if (hi == 2) {r = p; g = v; b = t;}
    else if (hi == 3) {r = p; g = q; b = v;}
    else if (hi == 4) {r = t; g = p; b = v;}
    else if (hi == 5) {r = v; g = p; b = q;}
    r = Math.floor(r * 255);
    g = Math.floor(g * 255);
    b = Math.floor(b * 255);
    return { r: r, g: g, b: b };
}


var animtimeout;

document.getElementById('animate').addEventListener('change', function(){
	if (this.checked) {
		animtimeout = setInterval(function(){
			controls.hueShift.value = (controls.hueShift.value + 1) % 360;
		}, 50);
	} else {
		clearInterval(animtimeout);
	}
});

var useTestPattern = false;

document.getElementById('testPattern').addEventListener('change', function(){
    if (this.checked) {
        useTestPattern = true;
    } else {
        useTestPattern = false;
    }
});

</script>
